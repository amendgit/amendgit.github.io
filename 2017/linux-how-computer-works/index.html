<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="导读在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Linux之计算机是怎样工作的">
<meta property="og:url" content="http://www.amendgit.com/2017/linux-how-computer-works/index.html">
<meta property="og:site_name" content="amendgit&#39;s blog">
<meta property="og:description" content="导读在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2017-03-31T14:14:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Linux之计算机是怎样工作的">
<meta name="twitter:description" content="导读在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>深入理解Linux之计算机是怎样工作的</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/amendgit">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        <li><a class="icon" href="#"><i class="fa fa-bars fa-lg" aria-hidden="true" onmouseover='$("#i-toc").toggle();' onmouseout='$("#i-toc").toggle();' onclick='$("#toc").toggle();return false;'></i></a></li>
        
        <li><a class="icon" href="/2017/linux-understand-process/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2017/linux-how-os-works/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-toc" class="info" style="display:none;">Table of content</span>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.amendgit.com/2017/linux-how-computer-works/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.amendgit.com/2017/linux-how-computer-works/&text=深入理解Linux之计算机是怎样工作的"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.amendgit.com/2017/linux-how-computer-works/&is_video=false&description=深入理解Linux之计算机是怎样工作的"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=深入理解Linux之计算机是怎样工作的&body=Check out this article: http://www.amendgit.com/2017/linux-how-computer-works/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.amendgit.com/2017/linux-how-computer-works/&name=深入理解Linux之计算机是怎样工作的&description=&lt;h2 id=&#34;导读&#34;&gt;&lt;a href=&#34;#导读&#34; class=&#34;headerlink&#34; title=&#34;导读&#34;&gt;&lt;/a&gt;导读&lt;/h2&gt;&lt;p&gt;在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过&lt;br&gt;"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#导读"><span class="toc-number">1.</span> <span class="toc-text">导读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、C语言的编译过程"><span class="toc-number">2.</span> <span class="toc-text">一、C语言的编译过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-C语言的编译过程"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 C语言的编译过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-源文件example-c"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 源文件example.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-预处理"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 预处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-编译成汇编代码"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 编译成汇编代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-汇编成目标代码"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 汇编成目标代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-链接"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 链接　　</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、C程序的运行"><span class="toc-number">3.</span> <span class="toc-text">二、C程序的运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-计算机是如何工作的"><span class="toc-number">4.</span> <span class="toc-text">三. 计算机是如何工作的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料："><span class="toc-number">5.</span> <span class="toc-text">参考资料：</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        深入理解Linux之计算机是怎样工作的
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">amendgit's blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-03-31T02:13:36.000Z" itemprop="datePublished">2017-03-31</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="导读"><a href="#导读" class="headerlink" title="导读"></a>导读</h2><p>在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过<br><a id="more"></a></p>
<h2 id="一、C语言的编译过程"><a href="#一、C语言的编译过程" class="headerlink" title="一、C语言的编译过程"></a>一、C语言的编译过程</h2><h3 id="1-1-C语言的编译过程"><a href="#1-1-C语言的编译过程" class="headerlink" title="1.1 C语言的编译过程"></a>1.1 C语言的编译过程</h3><p>由于是单文件的程序，因此链接的过程省略。详细参考《程序员的自我修养》第2.1节 被隐藏了的过程[1]</p>
<h3 id="1-2-源文件example-c"><a href="#1-2-源文件example-c" class="headerlink" title="1.2 源文件example.c"></a>1.2 源文件example.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example.c</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">g</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line">   return x + 3;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> g(x);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> f(<span class="number">8</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-预处理"><a href="#1-3-预处理" class="headerlink" title="1.3 预处理"></a>1.3 预处理</h3><p>预处理主要是处理宏指令和#include指令。使用命令 gcc -E -o example.cpp example.c。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span> <span class="string">"example.c"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;built-in&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"&lt;command-line&gt;"</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"example.c"</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">g</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> g(x);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f(<span class="number">8</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-编译成汇编代码"><a href="#1-4-编译成汇编代码" class="headerlink" title="1.4 编译成汇编代码"></a>1.4 编译成汇编代码</h3><p>编译的过程使用一系列的词法分析，语法分析，语义分析和优化后生成相应的汇编代码。使用命令 gcc -x cpp-output -S -o example.s example.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    .file    &quot;example.c&quot;</span><br><span class="line">    .text</span><br><span class="line">.globl g</span><br><span class="line">    .type    g, @function</span><br><span class="line">g:</span><br><span class="line">    pushl    %ebp</span><br><span class="line">    movl    %esp, %ebp</span><br><span class="line">    movl    8(%ebp), %eax</span><br><span class="line">    addl    $3, %eax</span><br><span class="line">    popl    %ebp</span><br><span class="line">    ret</span><br><span class="line">    .size    g, .-g</span><br><span class="line">.globl f</span><br><span class="line">    .type    f, @function</span><br><span class="line">f:</span><br><span class="line">    pushl    %ebp</span><br><span class="line">    movl    %esp, %ebp</span><br><span class="line">    subl    $4, %esp</span><br><span class="line">    movl    8(%ebp), %eax</span><br><span class="line">    movl    %eax, (%esp)</span><br><span class="line">    call    g</span><br><span class="line">    leave</span><br><span class="line">    ret</span><br><span class="line">    .size    f, .-f</span><br><span class="line">.globl main</span><br><span class="line">    .type    main, @function</span><br><span class="line">main:</span><br><span class="line">    leal    4(%esp), %ecx</span><br><span class="line">    andl    $-16, %esp</span><br><span class="line">    pushl    -4(%ecx)</span><br><span class="line">    pushl    %ebp</span><br><span class="line">    movl    %esp, %ebp</span><br><span class="line">    pushl    %ecx</span><br><span class="line">    subl    $4, %esp</span><br><span class="line">    movl    $8, (%esp)</span><br><span class="line">    call    f</span><br><span class="line">    addl    $1, %eax</span><br><span class="line">    addl    $4, %esp</span><br><span class="line">    popl    %ecx</span><br><span class="line">    popl    %ebp</span><br><span class="line">    leal    -4(%ecx), %esp</span><br><span class="line">    ret</span><br><span class="line">    .size    main, .-main</span><br><span class="line">    .ident    &quot;GCC: (Ubuntu 4.3.3-5ubuntu4) 4.3.3&quot;</span><br><span class="line">    .section    .note.GNU-stack,&quot;&quot;,@progbits</span><br></pre></td></tr></table></figure>
<h3 id="1-5-汇编成目标代码"><a href="#1-5-汇编成目标代码" class="headerlink" title="1.5 汇编成目标代码"></a>1.5 汇编成目标代码</h3><p>汇编器是将汇编代码转变成机器可以执行的指令，每一个汇编语句几乎都对应一条机器指令。所以汇编器的汇编过程相对于编译器来讲比较简单，它没有复杂的语法，也没有语义，也不需要做指令优化，只是根据汇编指令和机器指令的对照表一一翻译就可以了，“汇编”这个名字也来源于此。[1]</p>
<p>使用命令 <code>gcc -x assembler -c example.s -o example.o</code></p>
<h3 id="1-6-链接"><a href="#1-6-链接" class="headerlink" title="1.6 链接　　"></a>1.6 链接　　</h3><p>详见《程序员的自我修养》2.1.4 [1]</p>
<h2 id="二、C程序的运行"><a href="#二、C程序的运行" class="headerlink" title="二、C程序的运行"></a>二、C程序的运行</h2><p>现在我们观察汇编的代码，模拟C语言运行过程中栈的变化情况，来深入了解C程序的运行过程。</p>
<p>首先，C程序从main函数入口进入执行：</p>
<p><strong>28到30</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    27 main:</span><br><span class="line">-&gt;  28     leal    4(%esp), %ecx</span><br><span class="line">    29     andl    $-16, %esp</span><br><span class="line">    30     pushl    -4(%ecx)</span><br></pre></td></tr></table></figure>
<p>这三条指令是:将esp按照16字节对齐，然后再push esp。</p>
<p><strong>31到32行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  31     pushl    %ebp</span><br><span class="line">    32     movl    %esp, %ebp</span><br></pre></td></tr></table></figure>
<p>31行将ebp压栈，<br>32行将esp中的地址赋值给ebp，为了区别，我们使用ebp1表示。对应的栈示意图如下：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |      ebp      | &lt;- esp
       +---------------+
       |               |
   low +---------------+
</code></pre><p>此时，就搭建好了main函数运行的框架。</p>
<p><strong>33行</strong>:<br>继续看第33行代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  33     pushl    %ecx</span><br></pre></td></tr></table></figure>
<p>将ecx压栈，具体原因暂时不详，栈示意图。</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | 
       +---------------+
       |     ecx       | &lt;- esp
       +---------------+
       |               | 
  low  +---------------+
</code></pre><p><strong>34到36行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  34     subl    $4, %esp</span><br><span class="line">    35     movl    $8, (%esp)</span><br><span class="line">    36     call    f</span><br></pre></td></tr></table></figure>
<p>34行将esp向下减4个字节的大小，等价与分配了4个字节的空间。<br>35行将立即数8放入到esp指向的内存中，这其实是在压入参数。栈示意图</p>
<pre><code> high  +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>36是宏指令call，其作用等价于将当前cs : eip的值压入栈顶，cs : eip指向被调用函数的入口地址。[2]栈示意图:</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>接下来执行的是函数f，我们从15行开始继续看：</p>
<p><strong>15到17行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  15 f:</span><br><span class="line">    16     pushl    %ebp</span><br><span class="line">    17     movl    %esp, %ebp</span><br></pre></td></tr></table></figure>
<p>16行将ebp压栈<br>17行将esp的内容赋值给ebp,为了区别，我们将其命名为ebp2，栈示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp2-&gt; |     ebp1      | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>现在，f函数的执行框架搭好了。</p>
<p><strong>18到20行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  18     subl    $4, %esp</span><br><span class="line">    19     movl    8(%ebp), %eax</span><br><span class="line">    20     movl    %eax, (%esp)</span><br></pre></td></tr></table></figure>
<p>18行申请了一个4字节大小的栈空间<br>19行将ebp+8位置处的内容放入到eax寄存器中。ebp+8的位置，就是第一个参数的位置。所以，这句话其实是传参数。<br>20行将eax寄存器的内容放入到栈顶。对应的栈示意图。</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp2-&gt; |     ebp1      | 
       +---------------+
       |       8       | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p><strong>21行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  21     call    g</span><br></pre></td></tr></table></figure>
<p>21行调用函数g。call是宏指令，栈示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp2-&gt; |     ebp1      | 
       +---------------+
       |       8       | 
       +---------------+
       |    cs:eip     | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>现在观察函数g，汇编对应的是5到10行：</p>
<p><strong>5到7行</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  5 g:</span><br><span class="line">    6     pushl    %ebp</span><br><span class="line">    7     movl    %esp, %ebp</span><br></pre></td></tr></table></figure></p>
<p>　　6行，入栈ebp<br>　　7行，将esp赋值给ebp，为示区别，我们使用ebp3。</p>
<p>　　栈示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
       |     ebp1      | 
       +---------------+
       |       8       | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp3-&gt; |      ebp2     | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>函数g的执行环境搭建好了。<br>8到9行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt;   8     movl    8(%ebp), %eax</span><br><span class="line">     9     addl    $3, %eax</span><br></pre></td></tr></table></figure></p>
<p>8行，从ebp+8的位置出取参数，放入到eax寄存器中。<br>9行，将eax中的内容增加3。<br>此时，栈无任何变化。</p>
<p><strong>10-11行</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  10     popl    %ebp</span><br><span class="line">    11     ret</span><br></pre></td></tr></table></figure></p>
<p>20行，从栈顶取出数据，放入到ebp中。对应的栈变化如下：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp2-&gt; |     ebp1      | 
       +---------------+
       |       8       | 
       +---------------+
       |    cs:eip     | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>11行ret是个宏指令，其功能是从栈顶弹出原来保存在这里的cs : eip的值，放入cs : eip中。[2]<br>对应的栈变化示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
       |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | 
       +---------------+
ebp2-&gt; |     ebp1      | 
       +---------------+
       |       8       | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>此时，我们回到了f函数中call指令的下一条指令，即第22行。</p>
<p><strong>22行到23行</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  22     leave</span><br><span class="line">    23     ret</span><br></pre></td></tr></table></figure></p>
<p>22行，leave是宏指令，其相当于 movl %ebp, %esp和popl %ebp<br>运行后，栈示意图如下：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | 
       +---------------+
       |    cs:eip     | &lt;- esp
       +---------------+
       |               | 
   low +---------------+   
</code></pre><p>23行，ret恢复eip到main函数中call的下一条指令。栈示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | 
       +---------------+
       |     ecx       | 
       +---------------+
       |      8        | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p>此时，我们回到main函数的37行继续执行：</p>
<p><strong>37到39行</strong>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  37     addl    $1, %eax</span><br><span class="line">    38     addl    $4, %esp</span><br><span class="line">    39     popl    %ecx</span><br></pre></td></tr></table></figure></p>
<p>37行：将eax中的内容加1，注意eax通常用来做为返回值，所以，eax存储的是调用f后的返回值。<br>38行：将esp增加4，这是销毁了调用f的参数栈。<br>39行：将ecx寄存器恢复。还是不清楚，这是在做什么。<br>栈示意图：</p>
<pre><code>  high +---------------+
       |               |
       +---------------+
ebp1-&gt; |     ebp       | &lt;- esp
       +---------------+
       |               | 
   low +---------------+
</code></pre><p><strong>40到42行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  40     popl    %ebp    41     leal    -4(%ecx), %esp    42     ret</span><br></pre></td></tr></table></figure>
<p>40行：将栈顶内容出栈到ebp寄存器。<br>41行：将ecx-4中的内容出栈到esp，即将之前保存的esp内容出栈。<br>42行：将eip恢复到某个地方继续执行。结束。<br>现在，我们对C语言的程序执行调用用了大概的了解了。那么，计算机是怎样工作的呢。</p>
<h2 id="三-计算机是如何工作的"><a href="#三-计算机是如何工作的" class="headerlink" title="三. 计算机是如何工作的"></a>三. 计算机是如何工作的</h2><p>通过上面的分析，我们知道计算机的工作过程实际上就是取指令-&gt;执行指令的工程。其基本模型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">　　read_next_intruction();　　execute_intruction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在计算机中，又不单纯的是线性的执行下去。还有跳转指令，跳转指令是通过修改eip寄存器实现的，因为cpu每次是从eip指向的内存位置取下一条指令的。<br>单任务中，这个模型没什么问题。如果多任务怎么办呢？<br>多任务中，引入了中断的概念了。中断信号提供了一种特殊的方式，使得处理器转而去运行正常控制流之外的代码。当一个中断信号到达时，CPU必须停止它当前正在做的事情，并且切换到一个新的活动。[3]</p>
<p>这样，上面的模型就可以改成下面这样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    read_next_intruction();</span><br><span class="line">    execute_intruction();</span><br><span class="line">    detect_interrupt();   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中断的概念在计算机系统中非常重要，如：IO中断，时间片中断，系统调用中断等。<br>这样，我们就很基础的理解了计算机是怎样工作的了。<br>下一次，我会尝试自己编译Linux内核，欢迎持续关注。</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p>[1] 程序员的自我修养<br>[2] Linux操作系统分析所需的相关基础知识.ppt by 孟宁<br>[3] 深入理解Linux内核第三版</p>

  </div>
</article>



  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/amendgit">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#导读"><span class="toc-number">1.</span> <span class="toc-text">导读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、C语言的编译过程"><span class="toc-number">2.</span> <span class="toc-text">一、C语言的编译过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-C语言的编译过程"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 C语言的编译过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-源文件example-c"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 源文件example.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-预处理"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 预处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-编译成汇编代码"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 编译成汇编代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-汇编成目标代码"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 汇编成目标代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-链接"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 链接　　</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、C程序的运行"><span class="toc-number">3.</span> <span class="toc-text">二、C程序的运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-计算机是如何工作的"><span class="toc-number">4.</span> <span class="toc-text">三. 计算机是如何工作的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料："><span class="toc-number">5.</span> <span class="toc-text">参考资料：</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.amendgit.com/2017/linux-how-computer-works/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.amendgit.com/2017/linux-how-computer-works/&text=深入理解Linux之计算机是怎样工作的"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.amendgit.com/2017/linux-how-computer-works/&is_video=false&description=深入理解Linux之计算机是怎样工作的"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=深入理解Linux之计算机是怎样工作的&body=Check out this article: http://www.amendgit.com/2017/linux-how-computer-works/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.amendgit.com/2017/linux-how-computer-works/&title=深入理解Linux之计算机是怎样工作的"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.amendgit.com/2017/linux-how-computer-works/&name=深入理解Linux之计算机是怎样工作的&description=&lt;h2 id=&#34;导读&#34;&gt;&lt;a href=&#34;#导读&#34; class=&#34;headerlink&#34; title=&#34;导读&#34;&gt;&lt;/a&gt;导读&lt;/h2&gt;&lt;p&gt;在深入理解Linux之前，我们需要了解计算机是如何工作的。使用Example的c代码分别生成.cpp,.s,.o和ELF可执行文件，并加载运行，分析.s汇编代码在CPU上的执行过&lt;br&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 amendgit
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/amendgit">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>

<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


